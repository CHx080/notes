数据链路层要求相邻节点间的可靠数据帧传输，在数据出现丢包和无法纠正的错误时发送端需要重新发送数据帧。

## 自动重传请求协议

接收端需要知道哪些数据帧需要重传，这由接收端告知。

考虑最简单的情况，接收端每次收到一个数据帧后向发送端返回一个确认帧表明自己已经收到**正确的**数据帧，发送端必须收到确认帧后才可以继续发送下一帧。

如果数据帧丢包或出现了无法纠正的错误，接收端不会返回确认帧，发送端在等待超时后会判定数据帧丢失从而触发重传。*(图左)*

如果确认帧丢包，接收端也会在超时后触发重传。这会导致一个新的问题，接收端收到2个重复帧，理应丢弃一个，但是接收端无法辨别帧是否重复。为此引入**<u>数据帧序列号</u>**，序列号只需0~1交替，接收方连续收到2个序列号相同的数据帧即丢弃一个。*(图右)*

<img src="https://chx-typora.oss-cn-hangzhou.aliyuncs.com/typora/e1fb7ae3883c4cca48c4768eb78c9e1.jpg" alt="e1fb7ae3883c4cca48c4768eb78c9e1" style="zoom:50%;" />

这种经典模型存在的最大问题是传输效率非常低，总会有约一半的时间用于等待确认帧的到达。原因是经典模型太保守，其高估了丢包和错误的可能性，实际传输中丢包和错误毕竟少数，如果频繁丢包和错误，解决办法更应该是直接更换物理线路。

## 滑动窗口协议

滑动窗口协议用于解决经典模型的效率问题，协议允许**<u>发送端每一次可以发送多个数据帧</u>**。协议实现有2种：回退n帧和选择性重传。

### 回退n帧

**<u>回退n帧要求接收方数据帧必须按需按序到达</u>**，即只要帧号为k的数据包未收到或出现无法纠正的错误，即便收到了帧号大于k的正确数据帧，也全部丢弃。

<img src="https://chx-typora.oss-cn-hangzhou.aliyuncs.com/typora/4ac848ad63233fe32813d551f343034.jpg" alt="4ac848ad63233fe32813d551f343034" style="zoom:50%;" />

*以图为例，发送方只能收到ACK~0~     ACK~1~，待超时后会重传帧号大于等于3的数据帧*

### 选择性重传

选择性重传**<u>允许数据帧乱序到达</u>**，对于帧号非连续的帧接收方会将正确的数据帧**缓存**，并返回一个确认帧，注意这个**<u>确认帧序列号不一定等于最近收到数据帧的序列号</u>**，而是**<u>还未收到匹配数据帧的最小窗口号-1</u>**。一旦形成帧号连续的帧只需要返回最大帧号的确认帧即可，减少了重传次数。

假设接收窗口的大小为4且当前欲收到帧号1~4的数据帧*(帧号0的数据帧已确认)*，考虑3种情况

> + 收到帧号为5的数据帧

<img src="https://chx-typora.oss-cn-hangzhou.aliyuncs.com/typora/5cb4e04d7044a57d8a7c613a7581bf5.jpg" alt="5cb4e04d7044a57d8a7c613a7581bf5" style="zoom:50%;" />

​	*由于帧号5超出当前接收窗口的限制，只能丢弃。并向发送方返回ACK~0~，表明帧号0已经收到，请从帧号1及之后发送*

> + 收到帧号为1的数据帧

<img src="https://chx-typora.oss-cn-hangzhou.aliyuncs.com/typora/ea5887999aec7da2ff821d46568a0e3.jpg" alt="ea5887999aec7da2ff821d46568a0e3" style="zoom: 51%;" />

​	*帧号1在接收窗口之内，接收后窗口右滑一个单位。并向发送方返回ACK~1~，表明帧号1及其之前的帧已经收到，请从帧号2及之后发送*

> + 依次收到帧号为3、2、1的数据帧

<img src="https://chx-typora.oss-cn-hangzhou.aliyuncs.com/typora/6b6ca7ee7a36da46d7768947b08d34b.jpg" alt="6b6ca7ee7a36da46d7768947b08d34b" style="zoom:33%;" />

​	*帧号3在接收窗口之内允许接收，但由于帧号1、2的帧未到达，不可滑动窗口，故将帧3缓存并返回**ACK~0~**告知对端请从帧1及其之后发送；随后帧2到来，允许接收，但由于帧1未到，不可滑动窗口，故将帧2缓存并返回**ACK~0~......**；最后帧1到达接收，此时连续帧0-3已经正确接收，可以更新窗口，并返回**ACK~3~**标识帧3及其之前的帧已经收到，请从帧4及其之后发送*

​	*可以看到没有ACK~1~和ACK~2~，它们是不必要的*

​	***<u>当帧2和帧3被缓存后，只要在限定时间内帧1到达并让发送端获得ACK，帧2、3就不会触发重传；这是回退n帧无法做到的，回退n帧一定会导致帧2、3的重传</u>***。

### 窗口大小

数据帧序列号的范围*(0~N-1*)制约着收发窗口长度。显然**<u>窗口的大小绝不能大于序列号个数</u>**，否则窗口中就会出现序号相同的位置引发冲突。

实现不同，对收发窗口长度的约束也不同。

对于回退n帧。由于要求数据帧必须按序到达，故不需要缓存位置，接收窗口长度仅需1；而发送窗口长度最大为**N-1**以**<u>避免当前窗口的最后一个帧号出现在下一个窗口中</u>**。

对于选择性重传。发送窗口长度小于等于接收窗口长度，接收窗口长度最大为**⌊N/2⌋**以**<u>避免相邻窗口出现重复的帧号</u>**。